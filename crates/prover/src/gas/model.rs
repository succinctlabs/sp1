use itertools::izip;

pub const INPUT_SIZE: usize = 90;

pub fn predict(input: &[usize; INPUT_SIZE / 2]) -> f64 {
    let input = [input.map(|x| x as f64), input.map(|x| 2f64.powi(x.try_into().unwrap()))].concat();
    // Asserts that the zip does not end early.
    assert_eq!(input.len(), INPUT_SIZE);
    izip!(input, &PARAMS.mean, &PARAMS.std, &PARAMS.coefs)
        .filter_map(|(x, &mu, &sigma, &b)| {
            let term = ((x - mu) / sigma) * b;
            (term.is_finite()).then_some(term)
        })
        .sum::<f64>()
        + PARAMS.intercept
}

pub(crate) struct Params<const N: usize> {
    pub mean: [f64; N],
    pub std: [f64; N],
    pub coefs: [f64; N],
    pub intercept: f64,
}

pub(crate) const OVERHEAD: f64 = 140.21;

pub(crate) const PARAMS: Params<INPUT_SIZE> = Params {
    mean: [
        16.361931629605046,
        19.590026551609693,
        0.12678393627613674,
        0.18835048124792567,
        0.0809824095585795,
        0.014603385330235646,
        0.0,
        0.04563557915698639,
        0.0854629936939927,
        0.0,
        0.0,
        0.0,
        0.29754397610355127,
        0.0,
        0.0,
        0.0018254231662794558,
        0.010205774975107867,
        0.043644208430136076,
        0.0,
        0.09633255891138401,
        0.007218718884832393,
        0.0045635579156986395,
        1.2161466976435447,
        0.30277132426153336,
        0.39802522402920676,
        0.0,
        10.908396946564885,
        2.7508297378028543,
        1.5085462993693992,
        16.328991038831727,
        13.652173913043478,
        13.782359774311317,
        13.530036508463326,
        13.28468304015931,
        14.979588450049784,
        15.066213076667774,
        14.02032857616993,
        14.231164951875208,
        14.02032857616993,
        10.908396946564885,
        0.28957849319615003,
        0.3235147693328908,
        17.310155990706935,
        18.22402920677066,
        16.0,
        1608889.2240292067,
        833631.8406903419,
        2670.1785595751744,
        4286.109525389977,
        74.3445071357451,
        0.3219382675074676,
        0.0,
        49.27978758712247,
        97.20013275804845,
        0.0,
        0.0,
        0.0,
        2223.04945237305,
        0.0,
        0.0,
        1.3806837039495519,
        10.535678725522734,
        50.30268835048125,
        0.0,
        112.15399933620976,
        7.478260869565218,
        4.758048456687686,
        1422.6564885496184,
        352.6053767009625,
        464.079654829074,
        0.0,
        132568.06637902424,
        2936.480584135413,
        427.28974444075675,
        1581768.347826087,
        161158.49983405243,
        213944.79920345172,
        206736.0159309658,
        105891.04812479256,
        513769.9940258878,
        647379.3932957186,
        201111.15300365083,
        256696.0345170926,
        201111.15300365083,
        132568.06637902424,
        12432.185861267839,
        13877.188184533687,
        220726.71622967144,
        490170.28609359445,
        65536.0,
    ],
    std: [
        8.678463938310063,
        0.4918284457056826,
        1.4831242908955562,
        1.8294445265623487,
        1.034862000524069,
        0.3196504121835557,
        0.0,
        0.7918488467120067,
        1.0876754702960056,
        0.0,
        0.0,
        0.0,
        2.2213064619909377,
        0.0,
        0.0,
        0.14686677876387078,
        0.37377354365726145,
        0.7763002938490673,
        0.0,
        1.1568479604983752,
        0.31082526301796554,
        0.25057997848036545,
        3.9428368362990387,
        2.035288323405339,
        2.3257685938134784,
        0.0,
        7.9682038547494285,
        5.490666897168076,
        3.6142639720977394,
        8.664500011482128,
        7.263107524994937,
        7.408654540797566,
        7.544008106612818,
        7.048797792723433,
        7.964402728162053,
        8.044604545519633,
        7.437213791422573,
        7.560201874071038,
        7.437213791422573,
        7.9682038547494285,
        2.3299335534132863,
        2.483460321233254,
        2.4719575081096945,
        1.4808524878427352,
        0.0,
        871062.9551893679,
        257859.7521421409,
        36693.417500498545,
        46727.5675469515,
        1061.4424339663888,
        8.325754887749543,
        0.0,
        881.9445539239817,
        1250.4359810966298,
        0.0,
        0.0,
        0.0,
        16861.4685255539,
        0.0,
        0.0,
        149.2535963691917,
        403.4365829637425,
        906.4075231692552,
        0.0,
        1348.8455543243688,
        341.8740933841157,
        269.0073433059293,
        4612.947446898553,
        2376.1615290795703,
        2716.8913873728734,
        0.0,
        129986.72993149346,
        6128.050902147791,
        6211.0015762492185,
        877769.5282593172,
        129392.47457057897,
        203960.68770010822,
        201935.45109011172,
        63803.44136962137,
        367620.6126656859,
        595958.001355869,
        108882.86939867098,
        175612.70904935943,
        108882.86939867098,
        129986.72993149346,
        111647.6828476847,
        116776.30396995049,
        76788.80928085452,
        463056.17694709497,
        0.0,
    ],
    coefs: [
        1.7388754474962855,
        0.7805505378165287,
        -5.590947646908331,
        -6.003514148187673,
        4.069791196088427,
        1.5714118655439189,
        0.0,
        5.0065934699811026,
        7.555527946586934,
        0.0,
        0.0,
        0.0,
        13.543610528420443,
        0.0,
        0.0,
        1.9514779030057243,
        4.872733585319075,
        -1.942896843426853,
        0.0,
        -2.2259852881087654,
        0.11123891826585329,
        1.2968412429521445,
        -8.076980355152507,
        -2.5217737050156153,
        4.112987421982596,
        0.0,
        -3.736914932619576,
        -0.5775234665592046,
        4.177749395811018,
        5.731043963242733,
        -6.884403797109046,
        -20.85772976468555,
        -0.5389374725954369,
        -3.4733822051018994,
        6.506702454386307,
        0.16234455395621994,
        2.0848460832279962,
        3.1412438971263033,
        2.0848460832280034,
        -3.736914932617891,
        -0.6779999438184121,
        -6.394064867115037,
        5.934110092882137,
        4.4379636758163885,
        0.0,
        2.240320251904173,
        0.7805505377758669,
        6.284663054335032,
        11.034303767110377,
        0.3099653017608601,
        -0.7421703682888701,
        0.0,
        0.4749686025640203,
        -0.1305554840662548,
        0.0,
        0.0,
        0.0,
        15.611015682500456,
        0.0,
        0.0,
        0.06912695711049432,
        0.2505014460752302,
        -0.2876925962224145,
        0.0,
        -0.6637187922078526,
        0.1022961729211779,
        0.3517203982077712,
        -7.397237422377605,
        2.0160786617629647,
        3.206784074987937,
        0.0,
        7.494180760953027,
        1.7684756319940982,
        -0.5615333127265469,
        11.713768506763467,
        8.384590486124837,
        22.911212806989752,
        30.794384514259036,
        0.338920081484108,
        13.240596393867838,
        56.84938974516903,
        2.2403202519061494,
        9.46882457469021,
        2.2403202519061476,
        7.494180760955214,
        15.921792869794059,
        9.77062357870131,
        15.011178761001542,
        118.78973454863636,
        0.0,
    ],
    intercept: 474.3473832543146,
};
